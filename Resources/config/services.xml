<?xml version="1.0" ?>

<container xmlns="http://symfony.com/schema/dic/services"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd">

    <services>
        <defaults public="false" autowire="false" autoconfigure="false" />

        <service id="Yarhon\RouteGuardBundle\Security\AccessMapBuilder">
            <call method="setRouteCollectionTransformers">
                <argument type="collection" />
            </call>
            <call method="setTestProviders">
                <argument type="collection" />
            </call>
            <call method="setLogger">
                <argument type="service" id="logger" on-invalid="ignore" />
            </call>
            <call method="importRouteCollection">
                <argument type="service" id="router.default" on-invalid="ignore" />
            </call>
            <tag name="monolog.logger" channel="route_guard" />
        </service>

        <!-- test providers utility services -->

        <service id="Yarhon\RouteGuardBundle\ExpressionLanguage\ExpressionFactory">
            <argument type="service" id="security.expression_language" on-invalid="ignore"/>
            <argument type="collection" />
            <argument>null</argument><!--- false ? -->
        </service>

        <!-- test providers -->

        <service id="Yarhon\RouteGuardBundle\Annotations\ClassMethodAnnotationReader">
        </service>

        <service id="Yarhon\RouteGuardBundle\Security\Sensio\VariableResolver">
            <argument type="service" id="Yarhon\RouteGuardBundle\Routing\RequestAttributesFactory" />
            <argument type="service" id="Yarhon\RouteGuardBundle\Controller\ControllerArgumentResolver" />
            <argument type="service" id="request_stack" /><!-- to do: optional external services -->
        </service>

        <service id="Yarhon\RouteGuardBundle\Security\TestProvider\SensioSecurityProvider">
            <argument type="service" id="Yarhon\RouteGuardBundle\Annotations\ClassMethodAnnotationReader" />
            <argument type="service" id="Yarhon\RouteGuardBundle\Security\Sensio\VariableResolver" />
            <argument type="service" id="sensio_framework_extra.security.expression_language.default" on-invalid="ignore"/><!-- optional always! -->
            <argument type="service" id="argument_metadata_factory" on-invalid="ignore" /> <!-- optional always! -->
            <tag name="yarhon_route_guard.test_provider" priority="1024" />
        </service>

        <service id="Yarhon\RouteGuardBundle\Security\TestProvider\SymfonyAccessControlProvider">
            <argument type="service" id="Yarhon\RouteGuardBundle\ExpressionLanguage\ExpressionFactory" />
            <tag name="yarhon_route_guard.test_provider" priority="1023" />
        </service>

        <!-- route collection services -->

        <service id="Yarhon\RouteGuardBundle\Routing\RouteCollection\ControllerNameConverterTransformer">
            <argument type="service" id="Yarhon\RouteGuardBundle\Controller\ControllerNameConverter" />
            <tag name="yarhon_route_guard.route_collection_transformer" priority="1024" />
        </service>

        <service id="Yarhon\RouteGuardBundle\Routing\RouteCollection\ControllerNameTransformer">
            <argument type="service" id="Yarhon\RouteGuardBundle\Controller\ContainerControllerNameResolver" />
            <tag name="yarhon_route_guard.route_collection_transformer" priority="1023" />
        </service>

        <service id="Yarhon\RouteGuardBundle\Routing\RouteCollection\RemoveIgnoredTransformer">
            <argument type="collection" /> <!-- ignoredControllers -->
            <tag name="yarhon_route_guard.route_collection_transformer" priority="1022" />
        </service>

        <service id="Yarhon\RouteGuardBundle\Controller\ContainerControllerNameResolver">
            <argument type="service" id="Yarhon\RouteGuardBundle\DependencyInjection\Container\ClassMap" />
        </service>

        <service id="Yarhon\RouteGuardBundle\Controller\ControllerNameConverter">
            <argument type="service" id="kernel" />
        </service>


        <service id="Yarhon\RouteGuardBundle\DependencyInjection\Container\ClassMap" public="true"> <!-- is set as public only to be available for TYPE_REMOVE compiler pass -->
            <argument type="collection" /> <!-- map -->
        </service>

        <!-- test resolvers -->

        <service id="Yarhon\RouteGuardBundle\Routing\RequestAttributesFactory">
            <argument type="service" id="router.default" /><!-- to do: optional external services -->
        </service>

        <service id="Yarhon\RouteGuardBundle\Controller\ControllerArgumentResolver">
            <argument type="collection" />
        </service>

        <service id="Yarhon\RouteGuardBundle\Security\TestResolver\SensioSecurityResolver">
            <argument type="service" id="Yarhon\RouteGuardBundle\Security\Sensio\VariableResolver" />
            <tag name="yarhon_route_guard.test_resolver" />
        </service>

        <service id="Yarhon\RouteGuardBundle\Security\TestResolver\SymfonyAccessControlResolver">
            <argument type="service" id="request_stack" /><!-- to do: optional external services -->
            <argument type="service" id="router.default" /><!-- to do: optional external services -->
            <tag name="yarhon_route_guard.test_resolver" />
        </service>

        <service id="Yarhon\RouteGuardBundle\Security\TestResolver\DelegatingTestResolver">
            <argument type="collection" />
        </service>

        <!-- cache services -->

        <service id="Yarhon\RouteGuardBundle\CacheWarmer\AccessMapCacheWarmer">
            <argument type="service" id="Yarhon\RouteGuardBundle\Security\AccessMapBuilder" />
            <argument type="service" id="Yarhon\RouteGuardBundle\Security\AccessMap" />
            <tag name="kernel.cache_warmer" />
        </service>

        <service id="yarhon_route_guard.cache" class="Symfony\Component\Cache\Adapter\AdapterInterface">
            <factory class="Symfony\Component\Cache\Adapter\AbstractAdapter" method="createSystemCache" />
            <argument /> <!-- namespace -->
            <argument>0</argument> <!-- default lifetime -->
            <argument>null</argument> <!-- version -->
            <argument>%kernel.cache_dir%/route-guard</argument>
            <argument type="service" id="logger" on-invalid="ignore" />
            <tag name="monolog.logger" channel="cache" />
            <tag name="cache.pool" clearer="cache.app_clearer" />
        </service>

        <!-- authorization services -->

        <service id="Yarhon\RouteGuardBundle\Security\AccessMap">
            <argument type="service" id="yarhon_route_guard.cache" />
        </service>

        <service id="Yarhon\RouteGuardBundle\Security\RouteTestResolver">
            <argument type="service" id="Yarhon\RouteGuardBundle\Security\AccessMap" />
            <argument type="service" id="Yarhon\RouteGuardBundle\Security\TestResolver\DelegatingTestResolver" />
        </service>

        <service id="Yarhon\RouteGuardBundle\Security\RouteAuthorizationChecker">
            <argument type="service" id="Yarhon\RouteGuardBundle\Security\RouteTestResolver" />
            <argument type="service" id="security.authorization_checker" on-invalid="ignore" />
        </service>
        <service id="yarhon_route_guard.authorization_checker" alias="Yarhon\RouteGuardBundle\Security\RouteAuthorizationChecker" public="true"/>
        <service id="Yarhon\RouteGuardBundle\Security\RouteAuthorizationCheckerInterface" alias="yarhon_route_guard.authorization_checker" />

        <service id="Yarhon\RouteGuardBundle\Routing\AuthorizedUrlGenerator">
            <argument type="service" id="router.default" />
            <argument type="service" id="Yarhon\RouteGuardBundle\Security\RouteAuthorizationChecker" />
            <argument type="service" id="router.default" />
        </service>

        <!-- twig services -->

        <service id="Yarhon\RouteGuardBundle\Twig\Extension\RoutingExtension">
            <argument type="collection" /> <!-- options -->
            <tag name="twig.extension" />
        </service>

        <service id="Yarhon\RouteGuardBundle\Twig\RoutingRuntime">
            <argument type="service" id="Yarhon\RouteGuardBundle\Routing\AuthorizedUrlGenerator" />
            <tag name="twig.runtime" />
        </service>

        <!-- controller argument resolvers -->

        <service id="Yarhon\RouteGuardBundle\Controller\ArgumentResolver\RequestAttributeValueResolver">
            <tag name="yarhon_route_guard.argument_value_resolver" priority="100" />
        </service>

        <service id="Yarhon\RouteGuardBundle\Controller\ArgumentResolver\RequestValueResolver">
            <tag name="yarhon_route_guard.argument_value_resolver" priority="50" />
        </service>

        <service id="Yarhon\RouteGuardBundle\Controller\ArgumentResolver\SessionValueResolver">
            <tag name="yarhon_route_guard.argument_value_resolver" priority="50" />
        </service>

        <service id="Yarhon\RouteGuardBundle\Controller\ArgumentResolver\ServiceValueResolver">
            <argument type="service" id="service_container"/>
            <tag name="yarhon_route_guard.argument_value_resolver" priority="-50" />
        </service>

        <service id="Yarhon\RouteGuardBundle\Controller\ArgumentResolver\DefaultValueResolver">
            <tag name="yarhon_route_guard.argument_value_resolver" priority="-100" />
        </service>

        <service id="Yarhon\RouteGuardBundle\Controller\ArgumentResolver\VariadicValueResolver">
            <tag name="yarhon_route_guard.argument_value_resolver" priority="-150" />
        </service>

        <!-- decorated expression voter --> <!-- to do:: rename!!! -->

        <service id="Yarhon\RouteGuardBundle\Security\Authorization\SensioSecurityExpressionVoter">
            <argument type="service" id="sensio_framework_extra.security.expression_language.default" /><!-- to do use default security.expression_language ? -->
            <argument type="service" id="security.authentication.trust_resolver" />
            <argument type="service" id="security.authorization_checker" />
            <argument type="service" id="security.role_hierarchy" on-invalid="ignore" />
            <tag name="security.voter" />
        </service>

    </services>
</container>